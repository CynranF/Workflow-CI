name: MLflow CI with Conda (Skilled)

# =========================
# IZIN AGAR GITHUB ACTIONS BISA PUSH
# =========================
permissions:
  contents: write

# =========================
# TRIGGER WORKFLOW
# =========================
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  train:
    runs-on: ubuntu-latest

    steps:
      # =========================
      # STEP 1 — CHECKOUT REPOSITORY
      # =========================
      - name: Checkout repository
        uses: actions/checkout@v4

      # =========================
      # STEP 2 — SETUP CONDA VIA MICROMAMBA (PAKAI conda.yaml)
      # =========================
      - name: Setup micromamba (conda environment)
        uses: mamba-org/setup-micromamba@v1
        with:
          environment-file: MLProject/conda.yaml
          environment-name: obesity-ci-env
          cache-environment: true
          init-shell: bash

      # =========================
      # STEP 3 — VERIFIKASI ENVIRONMENT
      # =========================
      - name: Verify conda environment
        shell: bash
        run: |
          micromamba info
          micromamba list

      # =========================
      # STEP 4 — JALANKAN MLFLOW PROJECT (TRAINING)
      # =========================
      - name: Run MLflow Project (CI Training)
        shell: bash
        run: |
          cd MLProject
          micromamba run -n obesity-ci-env mlflow run . --env-manager=local

      # =========================
      # STEP 5 — SIMPAN ARTEFAK MLFLOW KE REPOSITORY (SKILLED)
      # =========================
      - name: Commit MLflow artifacts to repository
        shell: bash
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          echo "=== Git status BEFORE add ==="
          git status

          git add MLProject/mlruns || echo "No mlruns folder found"
          git commit -m "Save MLflow artifacts from CI run" || echo "Nothing to commit"
          git push
